<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colosseum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="card.js"></script>
    <script>
        const roomId = `[[${roomId}]]`;
        const kakaoId = `[[${session.kakaoId}]]`;
        const topic_date = `[[${date}]]`;
        const topic_period = parseInt(`[[${period}]]`);
        const topic_dday = getDday(addDays(topic_date, topic_period));
        const inTime = topic_dday[1] == '-' ? true : false;
        //console.log("roomId 확인 : " + roomId);
    </script>
    <style>
        body {
            margin: 0;
        }

        html,
        body {
            height: 100%;
        }
        .-translate-x-double {
            transform: translateX(-200%);
        }
    </style>
</head>
<body class="bg-zinc-900">
<div id="alertModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">

    <!-- 모달 내용 -->
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="alertModalTitle">
                Warning!
            </h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="alertModalBody">
                    Something went wrong.
                </p>
            </div>
        </div>
    </div>
</div>
<div class="left-10 justify-start absolute top-4 z-50">
    <div class="flex items-center justify-start rounded">
        <button class="bg-gray-700 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded shadow"
                onclick="goBack()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
            </svg>
        </button>
    </div>
</div>
<div class="w-11/12 h-5/6 rounded-3xl p-10 ">
    <div class="h-1/2 w-3/4 flex flex-col justify-center fixed bg-zinc-900 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
        <div class="font-bold mb-10 flex justify-center text-white" style="font-size: 4vw; margin-bottom: 1vw;" th:text="${topic}">
    </div>
    <div class="w-full flex justify-center" style="margin-bottom : 1vw;">
        <div class="pro text-white h-10 w-10 table-cell text-center text-sm rounded-3xl hover:cursor-pointer"
             onclick="sendVote(1)">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 20 20">
                <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
            </svg>
        </div>
        <div class="proPercentage mx-3 font-bold w-14 text-center text-white" style="line-height: 40px;" th:text="${view_pro_rate}"></div>
        <div class="w-1/2 h-5 rounded-lg bg-gray-300 flex">
            <div class="proGage h-full bg-yellow-300 rounded-l-lg w-1/4 text-center"
                 th:style="'width:'+${view_pro_rate}+'%'"
                 th:classappend="${view_pro_rate == '100.0'}? 'rounded-r-lg' : ''"></div>
            <div class="conGage h-full bg-blue-400 rounded-r-lg w-3/4 text-center"
                 th:style="'width:'+${view_con_rate}+'%'"
                 th:classappend="${view_con_rate == '100.0'}? 'rounded-l-lg' : ''"></div>
        </div>
        <div class="conPercentage mx-3 font-bold w-14 text-center text-white" style="line-height: 40px;" th:text="${view_con_rate}"></div>
        <div class="con text-white h-5 w-5 table-cell text-center text-sm rounded-3xl hover:cursor-pointer"
             onclick="sendVote(0)">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-hand-thumbs-down" viewBox="0 0 20 20">
                <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856 0 .289-.036.586-.113.856-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a9.877 9.877 0 0 1-.443-.05 9.364 9.364 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964l-.261.065zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a8.912 8.912 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581 0-.211-.027-.414-.075-.581-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.224 2.224 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.866.866 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1z"/>
            </svg>
        </div>
    </div>
    <div class="labelDiv w-full text-2xl font-bold w-20 flex justify-around">
        <span class="text-gray-500">찬성</span>
    </div>
    <div class="flex h-full w-[200%] sm:w-full">
        <!--section A-->
        <div class="h-full flex-1 overflow-y-auto  p-4 border-4 border-solid border-gray-500 rounded-xl section transition-transform duration-500 ease-in-out w-full"
             id="sectionA" style="height: 45vh;">
            <div class="flex flex-col space-y-2 msgProContainer">
                <!--찬성표-->
            </div>
        </div>
        <div class="w-1 max-h-full bg-black rounded-lg mx-10 hidden sm:block">

        </div>
        <!--section B-->
        <!-- hidden sm:block -->
        <div class="h-full flex-1 overflow-y-auto p-4 border-4 border-solid border-gray-500 rounded-xl section transition-transform duration-500 ease-in-out transform translate-x-full"
             id="sectionB" style="height: 45vh;">
            <div class="flex flex-col space-y-2 msgConContainer">
                <!--반대표-->
            </div>
        </div>
    </div>
    <div class=" p-4 flex items-center mt-4">
        <input type="text" placeholder="여러분의 의견을 말해주세요"
               class="msgInput flex-1 border rounded-full px-4 py-2 focus:outline-none" />
        <button class="bg-gray-700 text-white rounded-full p-2 ml-2 hover:bg-blue-600 focus:outline-none"
                onclick="sendMsg()">
            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                 stroke="#ffffff">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path
                            d="M11.5003 12H5.41872M5.24634 12.7972L4.24158 15.7986C3.69128 17.4424 3.41613 18.2643 3.61359 18.7704C3.78506 19.21 4.15335 19.5432 4.6078 19.6701C5.13111 19.8161 5.92151 19.4604 7.50231 18.7491L17.6367 14.1886C19.1797 13.4942 19.9512 13.1471 20.1896 12.6648C20.3968 12.2458 20.3968 11.7541 20.1896 11.3351C19.9512 10.8529 19.1797 10.5057 17.6367 9.81135L7.48483 5.24303C5.90879 4.53382 5.12078 4.17921 4.59799 4.32468C4.14397 4.45101 3.77572 4.78336 3.60365 5.22209C3.40551 5.72728 3.67772 6.54741 4.22215 8.18767L5.24829 11.2793C5.34179 11.561 5.38855 11.7019 5.407 11.8459C5.42338 11.9738 5.42321 12.1032 5.40651 12.231C5.38768 12.375 5.34057 12.5157 5.24634 12.7972Z"
                            stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </g>
            </svg>
        </button>
    </div>
    <div class="flex justify-center">
        <span class="text-gray-400 text-sm">모바일에서는 화면을 좌우로 스와이프 해주세요!</span>
    </div>
</div>
</div>

</body>

<script src="message.js"></script>
<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>
    let proCount = 0;
    let conCount = 0;
    let lastExecuted = 0;
    const labelDiv = document.querySelector('.labelDiv');

    sectionA.addEventListener('scroll', function () {
        if (sectionA.scrollTop === 0) {
            msgScrollXhr(1, proCount);
        }
    });
    sectionB.addEventListener('scroll', function () {
        if (sectionB.scrollTop === 0) {
            msgScrollXhr(0, conCount);
        }
    });

    document.querySelector('.msgInput').addEventListener('keyup', function (event) {
        if (event.key === 'Enter') {
            const now = Date.now();

            if (now - lastExecuted > 500) {
                if (event.key === 'Enter') {
                    sendMsg();
                    lastExecuted = now;
                }
            }

        }
    });

    function goBack() {
        window.history.back();
    }
    let smBreakPointFlag = false;
    const msgProContainer = document.querySelector('.msgProContainer');
    const msgConContainer = document.querySelector('.msgConContainer');
    const breakpoint = window.matchMedia("(min-width: 640px)");

    // 이벤트 리스너를 사용하여 브레이크포인트의 변경을 감지합니다.
    breakpoint.addListener((e) => {
        if (e.matches) {
            smBreakPointFlag = false;
            sectionA.classList.remove("section", "transition-transform", "duration-500", "ease-in-out", "-translate-x-double");
            sectionB.classList.remove("section", "transition-transform", "duration-500", "ease-in-out", "transform", "-translate-x-full", "translate-x-full");
            labelDiv.innerHTML="<span class='text-gray-500'>찬성</span><span class='text-gray-500'>반대</span>";
        } else {
            smBreakPointFlag = true;
            sectionA.classList.add("section", "transition-transform", "duration-500", "ease-in-out");
            sectionB.classList.add("section", "transition-transform", "duration-500", "ease-in-out", "transform", "translate-x-full");
            labelDiv.innerHTML="<span class='text-gray-500'>찬성</span>";
        }
    });

    if (breakpoint.matches) {
        smBreakPointFlag = false;
        sectionA.classList.remove("section", "transition-transform", "duration-500", "ease-in-out", "-translate-x-double");
        sectionB.classList.remove("section", "transition-transform", "duration-500", "ease-in-out", "transform", "translate-x-full");
        labelDiv.innerHTML="<span class='text-gray-500'>찬성</span><span class='text-gray-500'>반대</span>";
    } else {
        smBreakPointFlag = true;
        sectionA.classList.add("section", "transition-transform", "duration-500", "ease-in-out");
        sectionB.classList.add("section", "transition-transform", "duration-500", "ease-in-out", "transform", "translate-x-full");
        labelDiv.innerHTML="<span class='text-gray-500'>찬성</span>";
    }


    var socket = new SockJS('/ws');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        //console.log('Connected: ' + frame);
        stompClient.subscribe("/sub/topic/" + roomId, function (message) {
            let response = JSON.parse(message.body);
            //console.log(response);
            if (response.type == 'VOTE') {
                //console.log('VOTE!!!');
                if (response.isSuccess == 'success') {
                    const proGage = document.querySelector('.proGage');
                    const conGage = document.querySelector('.conGage');
                    const proPercentage = document.querySelector('.proPercentage');
                    const conPercentage = document.querySelector('.conPercentage');
                    const proPercent = response.proTotal == 0 ? 0 + '%' : (response.proTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);
                    const conPercent = response.conTotal == 0 ? 0 + '%' : (response.conTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);
                    proGage.style.width = (proPercent + '%');
                    conGage.style.width = (conPercent + '%');
                    if (proPercent == 100) {
                        proGage.classList.add("rounded-r-lg");
                    } else {
                        proGage.classList.remove("rounded-r-lg");
                    }
                    if (conPercent == 100) {
                        conGage.classList.add("rounded-l-lg");
                    } else {
                        conGage.classList.remove("rounded-l-lg");
                    }
                    proPercentage.innerText = (response.proTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);
                    conPercentage.innerText = (response.conTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);

                }
                else if (response.isSuccess == 'fail' && response.kakaoId == kakaoId) {
                    showAlert("경고", response.error);
                }

            } else if (response.type == 'MSG') {
                //console.log('MSG!!!!');
                setMsg(response);
            }
        });
        stompClient.subscribe("/user/queue/" + roomId, function (message) {
            let response = JSON.parse(message.body);
            showAlert("경고", response.error);
        });

    });
    function showAlert(title, message) {
        document.getElementById('alertModalTitle').innerText = title;
        document.getElementById('alertModalBody').innerText = message;

        document.getElementById('alertModal').classList.remove('hidden');

        // 1초 후에 모달을 자동으로 숨김
        setTimeout(function () {
            document.getElementById('alertModal').classList.add('hidden');
        }, 1000);
    }
        msgInitXhr();
</script>
<script th:if="${session.isLoggedIn == null}">
    function sendVote(isPro) {
        showAlert("경고", "로그인을 먼저 해주세요.");
    }
    function sendMsg() {
        showAlert("경고", "로그인을 먼저 해주세요.");
    }
</script>
<script th:if="${session.isLoggedIn != null}">
    function sendVote(isPro) {
        if(inTime){
            stompClient.send("/pub/msg", {}, JSON.stringify({ 'type': 'VOTE', 'kakaoId': kakaoId, 'roomId': roomId, 'isPro': isPro }));
        }
        else{
            showAlert("경고", "이미 기한이 지난 주제입니다.");
        }
    }
    function sendMsg() {
        msg = document.querySelector('.msgInput').value;
        if(msg == ''){
            showAlert("경고", "내용을 입력해주세요.");
        }
        else{
            if(inTime){
                document.querySelector('.msgInput').value = '';
                stompClient.send("/pub/msg", {}, JSON.stringify({ 'type': 'MSG', 'kakaoId': kakaoId, 'roomId': roomId, 'msg': msg }));
            }
            else{
                showAlert("경고", "이미 기한이 지난 주제입니다.");
            }
        }
    }
</script>
<script>

    let startX;
    let isDragging = false;

    const sectionA = document.getElementById('sectionA');
    const sectionB = document.getElementById('sectionB');

    function handleStart(x) {
        startX = x;
        isDragging = true;
    }

    function handleMove(x) {
        if (!isDragging) return;

        const diffX = x - startX;
        if (diffX < -50 && smBreakPointFlag) { // 오른쪽으로 스와이프/드래그
            sectionA.classList.add('-translate-x-double');
            sectionB.classList.remove('translate-x-full');
            sectionB.classList.add('-translate-x-full');
            labelDiv.innerHTML="<span class='text-gray-500'>반대</span>";
            isDragging = false;
        } else if (diffX > 50 && smBreakPointFlag) { // 왼쪽으로 스와이프/드래그
            sectionB.classList.add('translate-x-full');
            sectionB.classList.remove('-translate-x-full');
            sectionA.classList.remove('-translate-x-double');
            labelDiv.innerHTML="<span class='text-gray-500'>찬성</span>";
            isDragging = false;
        }
    }

    // 터치 이벤트 핸들러
    function handleTouchStart(e) {
        handleStart(e.touches[0].clientX);
    }

    function handleTouchMove(e) {
        handleMove(e.touches[0].clientX);
    }

    // 마우스 이벤트 핸들러
    function handleMouseDown(e) {
        handleStart(e.clientX);
    }

    function handleMouseMove(e) {
        handleMove(e.clientX);
    }

    function handleMouseUp() {
        isDragging = false;
    }

    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchmove', handleTouchMove);
    document.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
</script>


</html>
