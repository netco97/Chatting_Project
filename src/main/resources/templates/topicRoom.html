<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colosseum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script>
        const roomId = `[[${roomId}]]`;
        const kakaoId = `[[${session.kakaoId}]]`;
        console.log("roomId 확인 : " + roomId);
    </script>
    <style>
        body {
            margin: 0;
        }

        html,
        body {
            height: 100%;
        }
    </style>
</head>
<body class="bg-zinc-900">
<div id="alertModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">

    <!-- 모달 내용 -->
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="alertModalTitle">
                Warning!
            </h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="alertModalBody">
                    Something went wrong.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="left-10 justify-start absolute top-10 z-50">
    <div class="flex items-center justify-start rounded">
        <button class="bg-gray-700 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded shadow" onclick="goBack()">
            뒤로 가기
        </button>
    </div>
</div>
<div class="w-11/12 h-5/6 rounded-3xl p-10 flex flex-col justify-center fixed bg-zinc-900 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">

    <div class="text-4xl font-bold mb-10 flex justify-center text-white" th:text="${topic}">
    </div>
    <div class="w-full flex justify-center mb-10">
        <div class="pro bg-gray-700 text-white border-solid border-gray-500 border-2 h-5 w-12 table-cell text-center text-sm rounded-3xl hover:cursor-pointer" onclick="sendVote(1)" >찬성</div>
        <div class="proPercentage mx-3 font-bold w-14 text-center text-white" th:text="${view_pro_rate}"></div>
        <div class="w-1/2 h-5 rounded-lg bg-gray-300 flex">
            <div class="proGage h-full bg-yellow-300 rounded-l-lg w-1/4 text-center" th:style="'width:'+${view_pro_rate}+'%'" th:classappend="${view_pro_rate == '100.0'}? 'rounded-r-lg' : ''"></div>
            <div class="conGage h-full bg-blue-400 rounded-r-lg w-3/4 text-center" th:style="'width:'+${view_con_rate}+'%'" th:classappend="${view_con_rate == '100.0'}? 'rounded-l-lg' : ''"></div>
        </div>
        <div class="conPercentage mx-3 font-bold w-14 text-center text-white" th:text="${view_con_rate}"></div>
        <div class="con bg-gray-700 text-white border-solid border-gray-500 border-2 h-5 w-12 table-cell text-center text-sm rounded-3xl hover:cursor-pointer" onclick="sendVote(0)">반대</div>
    </div>
    <div class="flex h-full">
        <!--section A-->
        <div class="h-full flex-1 overflow-y-auto p-4 border-4 border-solid border-gray-500 rounded-xl">
            <div class="flex flex-col space-y-2">
                <!--찬성표-->
            </div>
        </div>
        <div class="w-1 max-h-full bg-black rounded-lg mx-10 hidden sm:block">

        </div>
        <!--section B-->
        <div class="h-full flex-1 overflow-y-auto p-4 border-4 border-solid border-gray-500 rounded-xl hidden sm:block">
            <div class="flex flex-col space-y-2">
                <!--반대표-->
            </div>
        </div>
    </div>
    <div class=" p-4 flex items-center">
        <input type="text" placeholder="여러분의 의견을 말해주세요" class="flex-1 border rounded-full px-4 py-2 focus:outline-none" />
        <button class="bg-gray-700 text-white rounded-full p-2 ml-2 hover:bg-blue-600 focus:outline-none">
            <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M11.5003 12H5.41872M5.24634 12.7972L4.24158 15.7986C3.69128 17.4424 3.41613 18.2643 3.61359 18.7704C3.78506 19.21 4.15335 19.5432 4.6078 19.6701C5.13111 19.8161 5.92151 19.4604 7.50231 18.7491L17.6367 14.1886C19.1797 13.4942 19.9512 13.1471 20.1896 12.6648C20.3968 12.2458 20.3968 11.7541 20.1896 11.3351C19.9512 10.8529 19.1797 10.5057 17.6367 9.81135L7.48483 5.24303C5.90879 4.53382 5.12078 4.17921 4.59799 4.32468C4.14397 4.45101 3.77572 4.78336 3.60365 5.22209C3.40551 5.72728 3.67772 6.54741 4.22215 8.18767L5.24829 11.2793C5.34179 11.561 5.38855 11.7019 5.407 11.8459C5.42338 11.9738 5.42321 12.1032 5.40651 12.231C5.38768 12.375 5.34057 12.5157 5.24634 12.7972Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
        </button>
    </div>
</div>
</body>

<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>


    function goBack() {
        window.history.back();
    }

    var socket = new SockJS('/ws');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe("/sub/topic/" + roomId, function (message) {
            let response = JSON.parse(message.body);
            console.log(response);
            if (response.type == 'VOTE') {
                console.log('VOTE!!!');
                if (response.isSuccess == 'success') {
                    const proGage = document.querySelector('.proGage');
                    const conGage = document.querySelector('.conGage');
                    const proPercentage = document.querySelector('.proPercentage');
                    const conPercentage = document.querySelector('.conPercentage');
                    const proPercent = response.proTotal == 0 ? 0+'%' : (response.proTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);
                    const conPercent = response.conTotal == 0 ? 0+'%' : (response.conTotal / (response.proTotal + response.conTotal) * 100).toFixed(2);
                    proGage.style.width = (proPercent + '%');
                    conGage.style.width = (conPercent + '%');
                    if(proPercent == 100){
                        proGage.classList.add("rounded-r-lg");
                    }else{
                        proGage.classList.remove("rounded-r-lg");
                    }
                    if(conPercent == 100){
                        conGage.classList.add("rounded-l-lg");
                    }else{
                        conGage.classList.remove("rounded-l-lg");
                    }
                    proPercentage.innerText = response.proTotal;
                    conPercentage.innerText = response.conTotal;
                }
                else if (response.isSuccess == 'fail') {
                    showAlert("경고", response.error);
                }

            } else if (response.type == 'MSG') {
                console.log('MSG!!!!');
            }
        });
    });



    function showAlert(title, message) {
        document.getElementById('alertModalTitle').innerText = title;
        document.getElementById('alertModalBody').innerText = message;

        document.getElementById('alertModal').classList.remove('hidden');

        // 1초 후에 모달을 자동으로 숨김
        setTimeout(function () {
            document.getElementById('alertModal').classList.add('hidden');
        }, 1000);
    }
</script>
<script th:if="${session.isLoggedIn == null}">
    function sendVote(isPro) {
        showAlert("경고", "로그인을 먼저 해주세요.");
    }
    function sendMsg() {
        showAlert("경고", "로그인을 먼저 해주세요.");
    }
</script>
<script th:if="${session.isLoggedIn != null}">
    function sendVote(isPro) {
        stompClient.send("/pub/msg", {}, JSON.stringify({ 'type': 'VOTE', 'kakaoId': kakaoId, 'roomId': roomId, 'isPro': isPro }));
    }
    function sendMsg() {
        stompClient.send("/pub/msg", {}, JSON.stringify({ 'type': 'MSG', 'kakaoId': kakaoId, 'roomId': roomId, 'msg': msg }));
    }
</script>
</html>